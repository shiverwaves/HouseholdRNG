name: Extract Tax Training Data

on:
  workflow_dispatch:
    inputs:
      state:
        description: 'State code (two letters, e.g., HI, CA, TX)'
        required: true
        default: 'HI'
      pums_year:
        description: 'PUMS data year'
        required: true
        default: '2022'
      bls_year:
        description: 'BLS OEWS data year'
        required: true
        default: '2023'
      output_mode:
        description: 'Output mode'
        required: true
        default: 'sql'
        type: choice
        options:
          - sql
          - database
      run_stages:
        description: 'Which stages to run'
        required: true
        default: 'all'
        type: choice
        options:
          - all
          - pums_only
          - bls_only
          - derived_only

env:
  PYTHON_VERSION: '3.11'

jobs:
  extract_pums:
    name: Extract PUMS
    runs-on: ubuntu-latest
    if: |
      github.event.inputs.run_stages == 'all' || 
      github.event.inputs.run_stages == 'pums_only'
    steps:
      - name: Validate inputs
        run: |
          STATE="${{ github.event.inputs.state }}"
          # Trim whitespace and convert to uppercase
          STATE=$(echo "$STATE" | tr -d ' ' | tr '[:lower:]' '[:upper:]')
          echo "STATE=$STATE" >> $GITHUB_ENV
          echo "Processing state: $STATE"
          
          # Validate state code is 2 letters
          if [[ ! "$STATE" =~ ^[A-Z]{2}$ ]]; then
            echo "Error: Invalid state code '$STATE'. Must be 2 letters (e.g., HI, CA, TX)"
            exit 1
          fi

      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install dependencies
        run: |
          pip install --upgrade pip
          pip install -r requirements.txt

      - name: Cache PUMS data
        uses: actions/cache@v4
        with:
          path: pums_cache
          key: pums-${{ env.STATE }}-${{ github.event.inputs.pums_year }}

      - name: Extract PUMS distributions
        env:
          OUTPUT_MODE: ${{ github.event.inputs.output_mode }}
          PUMS_YEAR: ${{ github.event.inputs.pums_year }}
          DB_URL: ${{ secrets.DATABASE_URL }}
        run: |
          echo "=== PUMS Extraction ==="
          echo "State: $STATE"
          echo "Year: $PUMS_YEAR"
          echo "Output: $OUTPUT_MODE"
          
          if [ "$OUTPUT_MODE" = "database" ]; then
            if [ -z "$DB_URL" ]; then
              echo "ERROR: DATABASE_URL secret not set!"
              echo "Go to Settings â†’ Secrets â†’ Actions â†’ Add DATABASE_URL"
              exit 1
            fi
            
            python scripts/extract_pums.py \
              --state "$STATE" \
              --year "$PUMS_YEAR" \
              --output database \
              --connection-string "$DB_URL"
          else
            python scripts/extract_pums.py \
              --state "$STATE" \
              --year "$PUMS_YEAR" \
              --output sql
          fi

      - name: Upload SQL artifacts
        if: github.event.inputs.output_mode == 'sql'
        uses: actions/upload-artifact@v4
        with:
          name: pums-sql-${{ env.STATE }}-${{ github.event.inputs.pums_year }}
          path: output/pums_distributions_*.sql
          retention-days: 90

      - name: Upload PUMS cache for derived stage
        if: github.event.inputs.run_stages == 'all'
        uses: actions/upload-artifact@v4
        with:
          name: pums-cache-${{ env.STATE }}-${{ github.event.inputs.pums_year }}
          path: pums_cache/
          retention-days: 1

  extract_bls:
    name: Extract BLS
    runs-on: ubuntu-latest
    if: |
      github.event.inputs.run_stages == 'all' || 
      github.event.inputs.run_stages == 'bls_only'
    steps:
      - name: Validate inputs
        run: |
          STATE="${{ github.event.inputs.state }}"
          STATE=$(echo "$STATE" | tr -d ' ' | tr '[:lower:]' '[:upper:]')
          echo "STATE=$STATE" >> $GITHUB_ENV
          echo "Processing state: $STATE"

      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install dependencies
        run: |
          pip install --upgrade pip
          pip install -r requirements.txt

      - name: Cache BLS data
        uses: actions/cache@v4
        with:
          path: bls_cache
          key: bls-${{ github.event.inputs.bls_year }}

      - name: Extract BLS occupation wages
        env:
          OUTPUT_MODE: ${{ github.event.inputs.output_mode }}
          BLS_YEAR: ${{ github.event.inputs.bls_year }}
          DB_URL: ${{ secrets.DATABASE_URL }}
        run: |
          echo "=== BLS Extraction ==="
          echo "State: $STATE"
          echo "Year: $BLS_YEAR"
          echo "Output: $OUTPUT_MODE"
          
          if [ "$OUTPUT_MODE" = "database" ]; then
            if [ -z "$DB_URL" ]; then
              echo "ERROR: DATABASE_URL secret not set!"
              exit 1
            fi
            
            python scripts/extract_bls.py \
              --state "$STATE" \
              --year "$BLS_YEAR" \
              --output database \
              --connection-string "$DB_URL"
          else
            python scripts/extract_bls.py \
              --state "$STATE" \
              --year "$BLS_YEAR" \
              --output sql
          fi

      - name: Upload SQL artifacts
        if: github.event.inputs.output_mode == 'sql'
        uses: actions/upload-artifact@v4
        with:
          name: bls-sql-${{ env.STATE }}-${{ github.event.inputs.bls_year }}
          path: output/bls_occupation_wages_*.sql
          retention-days: 90

      - name: Upload BLS cache for derived stage
        if: github.event.inputs.run_stages == 'all'
        uses: actions/upload-artifact@v4
        with:
          name: bls-cache-${{ github.event.inputs.bls_year }}
          path: bls_cache/
          retention-days: 1

  extract_derived:
    name: Extract Derived
    runs-on: ubuntu-latest
    needs: [extract_pums, extract_bls]
    if: |
      always() &&
      (github.event.inputs.run_stages == 'all' || 
       github.event.inputs.run_stages == 'derived_only') &&
      (needs.extract_pums.result == 'success' || needs.extract_pums.result == 'skipped') &&
      (needs.extract_bls.result == 'success' || needs.extract_bls.result == 'skipped')
    steps:
      - name: Validate inputs
        run: |
          STATE="${{ github.event.inputs.state }}"
          STATE=$(echo "$STATE" | tr -d ' ' | tr '[:lower:]' '[:upper:]')
          echo "STATE=$STATE" >> $GITHUB_ENV
          echo "Processing state: $STATE"

      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install dependencies
        run: |
          pip install --upgrade pip
          pip install -r requirements.txt

      - name: Download PUMS cache
        if: github.event.inputs.run_stages == 'all'
        uses: actions/download-artifact@v4
        with:
          name: pums-cache-${{ env.STATE }}-${{ github.event.inputs.pums_year }}
          path: pums_cache/

      - name: Download BLS cache
        if: github.event.inputs.run_stages == 'all'
        uses: actions/download-artifact@v4
        with:
          name: bls-cache-${{ github.event.inputs.bls_year }}
          path: bls_cache/

      - name: Extract derived distributions
        env:
          OUTPUT_MODE: ${{ github.event.inputs.output_mode }}
          PUMS_YEAR: ${{ github.event.inputs.pums_year }}
          BLS_YEAR: ${{ github.event.inputs.bls_year }}
          DB_URL: ${{ secrets.DATABASE_URL }}
        run: |
          echo "=== Derived Tables Extraction ==="
          echo "State: $STATE"
          echo "PUMS Year: $PUMS_YEAR"
          echo "BLS Year: $BLS_YEAR"
          echo "Output: $OUTPUT_MODE"
          
          if [ "$OUTPUT_MODE" = "database" ]; then
            if [ -z "$DB_URL" ]; then
              echo "ERROR: DATABASE_URL secret not set!"
              exit 1
            fi
            
            python scripts/extract_derived.py \
              --state "$STATE" \
              --pums-year "$PUMS_YEAR" \
              --bls-year "$BLS_YEAR" \
              --output database \
              --connection-string "$DB_URL"
          else
            python scripts/extract_derived.py \
              --state "$STATE" \
              --pums-year "$PUMS_YEAR" \
              --bls-year "$BLS_YEAR" \
              --output sql
          fi

      - name: Upload SQL artifacts
        if: github.event.inputs.output_mode == 'sql'
        uses: actions/upload-artifact@v4
        with:
          name: derived-sql-${{ env.STATE }}-pums${{ github.event.inputs.pums_year }}-bls${{ github.event.inputs.bls_year }}
          path: output/derived_distributions_*.sql
          retention-days: 90

  summary:
    name: Summary
    runs-on: ubuntu-latest
    needs: [extract_pums, extract_bls, extract_derived]
    if: always()
    steps:
      - name: Generate summary
        run: |
          STATE="${{ github.event.inputs.state }}"
          STATE=$(echo "$STATE" | tr -d ' ' | tr '[:lower:]' '[:upper:]')
          
          echo "# Tax Training Data Extraction" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## Configuration" >> $GITHUB_STEP_SUMMARY
          echo "- **State:** $STATE" >> $GITHUB_STEP_SUMMARY
          echo "- **PUMS Year:** ${{ github.event.inputs.pums_year }}" >> $GITHUB_STEP_SUMMARY
          echo "- **BLS Year:** ${{ github.event.inputs.bls_year }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Output Mode:** ${{ github.event.inputs.output_mode }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Stages:** ${{ github.event.inputs.run_stages }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          echo "## Results" >> $GITHUB_STEP_SUMMARY
          echo "- **PUMS:** ${{ needs.extract_pums.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- **BLS:** ${{ needs.extract_bls.result }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Derived:** ${{ needs.extract_derived.result }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ "${{ github.event.inputs.output_mode }}" = "sql" ]; then
            echo "## ðŸ“¦ SQL Files" >> $GITHUB_STEP_SUMMARY
            echo "Download artifacts from the workflow run page." >> $GITHUB_STEP_SUMMARY
          else
            echo "## âœ… Database Upload" >> $GITHUB_STEP_SUMMARY
            echo "Data uploaded to Neon PostgreSQL." >> $GITHUB_STEP_SUMMARY
          fi
